# CursorFlow 핵심 모듈 및 파일 가이드

이 문서는 CursorFlow의 주요 모듈과 파일들의 역할, 그리고 이들이 전체 시스템에서 어떻게 상호작용하는지를 설명합니다.

## 📁 디렉토리 구조 개요

```
src/
├── cli/          # 사용자 커맨드 라인 인터페이스 진입점
├── core/         # 오케스트레이션 및 실행 로직 (Core Engine)
├── services/     # 로깅, 프로세스 관리 등 공통 서비스 인프라
├── utils/        # Git, Config, Health Check 등 헬퍼 유틸리티
└── types/        # TypeScript 타입 정의
```

---

## 1. CLI (`src/cli`)

사용자와 상호작용하며 명령어를 파싱하고 적절한 코어 로직을 호출하는 진입점입니다.

*   **`index.ts`**:
    *   **역할**: 메인 진입점(Entry Point). `process.argv`를 파싱하고 `init`, `run`, `monitor` 등의 하위 명령어로 라우팅합니다.
    *   **활용**: 사용자가 `cursorflow <command>`를 실행할 때 가장 먼저 실행됩니다.
*   **`run.ts`**:
    *   **역할**: `run` 명령어 핸들러. 사용자의 실행 옵션을 파싱하여 `core/orchestrator.ts`를 호출합니다.
*   **`monitor.ts`**:
    *   **역할**: 실행 중인 워크플로우의 상태를 보여주는 대시보드 UI를 제공합니다.
*   **기타 커맨드 (`init.ts`, `new.ts`, `add.ts`)**:
    *   **역할**: 프로젝트 초기화 및 새로운 Flow/Task 생성 설정을 담당합니다.

## 2. Core (`src/core`)

CursorFlow의 핵심 엔진으로, 병렬 실행 관리, 에러 복구, 작업 실행을 담당합니다.

*   **`orchestrator.ts`**:
    *   **역할**: **중앙 관리자(Brain)**.
        *   여러 `Lane`(병렬 작업 줄)을 관리합니다.
        *   Git Worktree를 생성하여 각 Lane을 격리합니다.
        *   Lane 간의 의존성(Dependency)을 해결하고, 교착 상태(Deadlock)를 방지합니다.
        *   `runner` 프로세스를 자식 프로세스로 실행합니다.
    *   **활용**: `cursorflow run` 실행 시 호출되며, 전체 수명 주기를 관리합니다.
*   **`runner.ts`**:
    *   **역할**: **개별 작업자(Worker)**.
        *   Orchestrator에 의해 별도 프로세스로 실행됩니다.
        *   할당된 `tasks.json`을 읽고 순차적으로 에이전트 작업을 수행합니다.
        *   격리된 Git Worktree 내부에서 동작합니다.
    *   **활용**: 각 Lane마다 하나씩 생성되어 실제 AI 에이전트 명령을 수행합니다.
*   **`stall-detection.ts`**:
    *   **역할**: 작업이 멈췄는지(Stall) 감지합니다.
    *   **활용**: Orchestrator가 주기적으로 체크하여, 특정 Lane이 오랫동안 응답이 없으면 재시작하거나 알림을 보냅니다.
*   **`auto-recovery.ts`**:
    *   **역할**: 실패 시 자동 복구 전략을 수립합니다.
    *   **활용**: Git 충돌이나 네트워크 오류 등으로 Lane이 실패했을 때, 자동으로 재시도하거나 사용자에게 가이드를 제공합니다.

## 3. Services (`src/services`)

비즈니스 로직과 무관한 인프라성 기능을 제공합니다.

*   **`logging/`**:
    *   **`index.ts` / `manager.ts`**:
        *   **역할**: 구조화된 로깅 시스템. 콘솔 출력과 파일 저장을 동시에 처리합니다.
        *   **활용**: 여러 Lane에서 동시에 쏟아지는 로그를 `[Lane-1]`과 같이 태깅하여 섞이지 않게 출력하고, 파일로도 기록합니다.

## 4. Utils (`src/utils`)

여러 모듈에서 공통적으로 사용되는 헬퍼 함수들입니다.

*   **`cursor-agent.ts`**:
    *   **역할**: `cursor-agent` CLI 도구와의 인터페이스 래퍼(Wrapper).
    *   **활용**: 에이전트가 설치되어 있는지 확인하고, 버전을 체크하며, 실제로 에이전트 프로세스를 실행하는 명령어를 생성합니다.
*   **`git.ts`**:
    *   **역할**: Git 명령어 실행 래퍼.
    *   **활용**: Worktree 생성, 브랜치 체크아웃, 커밋, 푸시 등의 작업을 안전하게 수행합니다.
*   **`state.ts`**:
    *   **역할**: 각 Lane의 진행 상태(State)를 JSON 파일로 저장하고 불러옵니다.
    *   **활용**: 작업이 중단되었다가 재개(Resume)될 때 어디서부터 시작해야 할지 추적합니다.
*   **`health.ts`**:
    *   **역할**: 시스템 상태 점검(Doctor).
    *   **활용**: 실행 전 필수 도구 설치 여부, 인증 상태 등을 점검합니다.

## 5. Types (`src/types`)

*   **역할**: 프로젝트 전반에서 사용되는 TypeScript 인터페이스 및 타입 정의 (`LaneConfig`, `Task`, `RunState` 등).
*   **활용**: 컴파일 타임 타입 체크 및 코드 자동완성을 위해 모든 모듈에서 참조합니다.
