# CursorFlow Run

## Overview

Execute AI agent orchestration using task configurations generated by `prepare`. CursorFlow uses a DAG (Directed Acyclic Graph) scheduler to handle lane dependencies and automatic branch merging.

## Workflow

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ 1. Create Lanes │ ──▶ │ 2. Add Tasks    │ ──▶ │ 3. Validate     │ ──▶ │ 4. Run          │
│ (prepare)       │     │ (prepare)       │     │ (doctor)        │     │ (run)           │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
```

## Usage

```bash
cursorflow run <tasks-dir> [options]
```

### Quick Start

```bash
# Step 1: Create lanes
cursorflow prepare AddAPI --prompt "Create REST API for users" --criteria "CRUD works,Tests pass"

# Step 2: (Optional) Add more lanes or tasks
cursorflow prepare --add-lane _cursorflow/tasks/2412211530_AddAPI \
  --prompt "Add authentication" --depends-on "01-lane-1"

# Step 3: Validate configuration
cursorflow doctor --tasks-dir _cursorflow/tasks/2412211530_AddAPI

# Step 4: Run
cursorflow run _cursorflow/tasks/2412211530_AddAPI

# Or run the latest prepared task
cursorflow run latest
```

## How It Works

1. **Load**: Read all JSON files from the tasks directory
2. **Validate**: Check `tasks` array, required fields (`name`, `prompt`)
3. **Resolve**: Build execution order from `dependsOn` dependencies
4. **Execute**:
   - Start lanes with no dependencies in parallel
   - When a lane completes, unlock dependent lanes
   - **Dependent lanes auto-merge predecessor branches before starting**
5. **Monitor**: Heartbeat logs every 30 seconds

## Options

| Option | Description |
|--------|-------------|
| `<tasks-dir>` | Directory containing JSON task files |
| `--max-concurrent <num>` | Limit concurrent lane execution |
| `--executor <type>` | `cursor-agent` (default) or `cloud` |
| `--skip-doctor` | Skip environment checks (not recommended) |
| `--dry-run` | Show execution plan without running |

## Execution Flow

### Single Lane

```bash
cursorflow prepare SimpleFix --prompt "Fix the bug"
cursorflow run _cursorflow/tasks/2412211530_SimpleFix
```

```
┌─────────────────────────────────────────────────────────┐
│  01-lane-1                                              │
│  ┌─────────┐                                            │
│  │implement│ → AI executes → Review → Complete          │
│  └─────────┘                                            │
└─────────────────────────────────────────────────────────┘
```

### Multiple Tasks in Lane

```bash
cursorflow prepare Feature \
  --task "plan|sonnet-4.5-thinking|Create plan|Plan ready" \
  --task "implement|sonnet-4.5|Build feature|Code done"
```

```
┌─────────────────────────────────────────────────────────┐
│  01-lane-1                                              │
│  ┌────┐     ┌─────────┐                                 │
│  │plan│ ──▶ │implement│ → Review → Complete             │
│  └────┘     └─────────┘                                 │
└─────────────────────────────────────────────────────────┘
```

### Sequential Lanes (with `--sequential`)

```bash
cursorflow prepare FullStack --lanes 3 --sequential \
  --prompt "Implement your layer"
```

```
┌───────────┐     ┌───────────┐     ┌───────────┐
│ 01-lane-1 │ ──▶ │ 02-lane-2 │ ──▶ │ 03-lane-3 │
│ (DB)      │     │ (API)     │     │ (UI)      │
└───────────┘     └───────────┘     └───────────┘
                        │                 │
                    merges 01         merges 01,02
```

### Parallel Lanes

```bash
cursorflow prepare FrontBack --lanes 2 \
  --prompt "Implement your layer"
```

```
┌───────────┐
│ 01-lane-1 │  (Frontend)
└───────────┘
              ─── both run in parallel
┌───────────┐
│ 02-lane-2 │  (Backend)
└───────────┘
```

## JSON Schema (RunnerConfig)

Each JSON file in the tasks directory follows this schema:

```json
{
  "baseBranch": "main",
  "branchPrefix": "feature/lane-1-",
  "timeout": 300000,
  "enableIntervention": false,
  "dependsOn": ["01-lane-1"],
  "dependencyPolicy": {
    "allowDependencyChange": false,
    "lockfileReadOnly": true
  },
  "enableReview": true,
  "reviewModel": "sonnet-4.5-thinking",
  "maxReviewIterations": 3,
  "tasks": [
    {
      "name": "implement",
      "prompt": "Create a reusable button component...",
      "model": "sonnet-4.5",
      "acceptanceCriteria": ["Build passes", "Tests pass"]
    }
  ]
}
```

### Configuration Reference

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `baseBranch` | string | Yes | Branch to create worktree from |
| `branchPrefix` | string | Yes | Prefix for feature branch naming |
| `tasks` | Task[] | Yes | Array of task objects to execute |
| `dependsOn` | string[] | No | Lane names to wait for and merge |
| `timeout` | number | No | Task timeout in ms (default: 300000) |
| `enableIntervention` | boolean | No | Allow stdin injection during execution |
| `dependencyPolicy.allowDependencyChange` | boolean | No | Allow package.json modifications |
| `dependencyPolicy.lockfileReadOnly` | boolean | No | Keep lockfile read-only |
| `enableReview` | boolean | No | Enable AI code review (default: true) |
| `reviewModel` | string | No | Model for code review |
| `maxReviewIterations` | number | No | Max review cycles (default: 3) |

### Task Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Task identifier (alphanumeric, `-`, `_`) |
| `prompt` | string | Yes | Instructions for the AI agent |
| `model` | string | No | Model override for this task |
| `acceptanceCriteria` | string[] | No | Criteria for AI reviewer validation |

## Monitoring During Execution

```bash
# In another terminal
cursorflow monitor latest

# Or specify the task directory
cursorflow monitor _cursorflow/tasks/2412211530_AddAPI
```

The monitor shows:
- Lane status (pending, running, completed, failed)
- Current task within each lane
- Dependency graph and progress
- Real-time log streaming

## Troubleshooting

### Validation Errors

```
Task N missing required "name" field
```
→ Ensure every task has both `name` and `prompt` fields

```
Invalid task name: "my task"
```
→ Task names can only contain alphanumeric characters, `-`, and `_`

### Dependency Issues

```
Circular dependency detected
```
→ Check your `dependsOn` fields for cycles (A→B, B→A)

```
Unknown dependency: 01-lane-99
```
→ Verify the lane name in `dependsOn` matches an actual JSON filename

### Merge Conflicts

When a dependent lane's auto-merge fails:

1. Find the worktree path in `cursorflow monitor`
2. Navigate to the worktree directory
3. Resolve conflicts manually and commit
4. Resume with `cursorflow resume <lane-name>`

### Lane Stuck

If a lane stops responding:

1. Check the agent window in Cursor IDE
2. Use `cursorflow signal <lane-name> --message "continue"` to nudge
3. Or terminate and restart with `cursorflow run --resume`

## Best Practices

1. **Always Validate First**: Run `cursorflow doctor --tasks-dir <dir>` before `run`
2. **Start Small**: Test with a single lane before scaling up
3. **Use `--dry-run`**: Preview execution plan before committing
4. **Monitor Actively**: Keep `cursorflow monitor` running in a separate terminal
5. **Plan Dependencies**: Draw out the DAG before running complex workflows
6. **Include Verification**: Add verify tasks to catch edge cases
