{
  "repository": "https://github.com/eungjin-cigro/cursorflow",
  "baseBranch": "main",
  "branchPrefix": "refactor/git-validation-tests-",
  "executor": "cursor-agent",
  "autoCreatePr": false,
  "allowDependencyChange": false,
  "lockfileReadOnly": true,
  "pollInterval": 60,

  "laneNumber": 3,
  "devPort": 3003,

  "enableReview": true,
  "reviewModel": "gemini-3-flash",
  "maxReviewIterations": 2,

  "dependsOn": ["01-types-tests"],

  "tasks": [
    {
      "name": "extract-git-service-code",
      "model": "gemini-3-flash",
      "acceptanceCriteria": [
        "Code extracted from phase-3-git.md",
        "Files created in src/services/git/",
        "All 8 files from documentation extracted"
      ],
      "prompt": "## Task: Extract Git Service Code from Documentation\n\n### Goal\nExtract Git service code from phase-3-git.md documentation.\n\n### Instructions\n1. Read the documentation:\n   ```bash\n   cat docs/refactoring/phase-3-git.md\n   ```\n\n2. Create directory structure:\n   ```bash\n   mkdir -p src/services/git\n   ```\n\n3. The documentation defines these files:\n   - types.ts\n   - utils.ts\n   - worktree.ts\n   - branch.ts\n   - commit.ts\n   - remote.ts\n   - merge.ts\n   - index.ts\n\n4. Find code block locations:\n   ```bash\n   grep -n '// src/services/git/' docs/refactoring/phase-3-git.md\n   ```\n\n5. Extract each code block using sed:\n   ```bash\n   # Example: extract types.ts\n   # Find the line with the file path comment, then extract until closing ```\n   awk '/\\/\\/ src\\/services\\/git\\/types.ts/,/^```$/' docs/refactoring/phase-3-git.md | sed '1d;$d'\n   ```\n\n6. For each file, save the extracted content:\n   ```bash\n   # types.ts\n   awk '/\\/\\/ src\\/services\\/git\\/types.ts/,/^```$/' docs/refactoring/phase-3-git.md | sed '1d;$d' > src/services/git/types.ts\n   \n   # Repeat for other files...\n   ```\n\n7. Verify extraction:\n   ```bash\n   ls -la src/services/git/\n   cat src/services/git/index.ts\n   ```\n\n### Important\n- Extract code ONLY from documentation using terminal commands\n- DO NOT write any code manually\n\n### Output\nList of created files with line counts."
    },
    {
      "name": "extract-validation-service-code",
      "model": "gemini-3-flash",
      "acceptanceCriteria": [
        "Code extracted from phase-4-validation.md",
        "Files created in src/services/validation/",
        "All 7 files from documentation extracted"
      ],
      "prompt": "## Task: Extract Validation Service Code from Documentation\n\n### Goal\nExtract Validation service code from phase-4-validation.md documentation.\n\n### Instructions\n1. Read the documentation:\n   ```bash\n   cat docs/refactoring/phase-4-validation.md\n   ```\n\n2. Create directory structure:\n   ```bash\n   mkdir -p src/services/validation\n   ```\n\n3. The documentation defines these files:\n   - types.ts\n   - environment.ts\n   - config.ts\n   - tasks.ts\n   - dependencies.ts\n   - reporter.ts\n   - index.ts\n\n4. Find code blocks:\n   ```bash\n   grep -n '// src/services/validation/' docs/refactoring/phase-4-validation.md\n   ```\n\n5. Extract each file:\n   ```bash\n   # Example extraction pattern\n   awk '/\\/\\/ src\\/services\\/validation\\/types.ts/,/^```$/' docs/refactoring/phase-4-validation.md | sed '1d;$d' > src/services/validation/types.ts\n   ```\n\n6. Verify all files created:\n   ```bash\n   ls -la src/services/validation/\n   wc -l src/services/validation/*.ts\n   ```\n\n### Output\nList of created files with line counts."
    },
    {
      "name": "review-services-code",
      "model": "gemini-3-flash",
      "acceptanceCriteria": [
        "Both Git and Validation services reviewed",
        "TypeScript compilation passes for both",
        "Import paths are correct",
        "Missing pieces documented"
      ],
      "prompt": "## Task: Review Git and Validation Services\n\n### Goal\nReview both extracted services for completeness and correctness.\n\n### Instructions\n1. Check Git service:\n   ```bash\n   echo '=== Git Service ===' \n   ls src/services/git/\n   npx tsc --noEmit src/services/git/*.ts 2>&1 | head -50\n   ```\n\n2. Check Validation service:\n   ```bash\n   echo '=== Validation Service ==='\n   ls src/services/validation/\n   npx tsc --noEmit src/services/validation/*.ts 2>&1 | head -50\n   ```\n\n3. Verify imports:\n   ```bash\n   echo '=== Git Imports ==='\n   grep -rh '^import' src/services/git/ | sort | uniq\n   \n   echo '=== Validation Imports ==='\n   grep -rh '^import' src/services/validation/ | sort | uniq\n   ```\n\n4. Check for cross-service dependencies:\n   ```bash\n   grep -r 'services/git' src/services/validation/\n   grep -r 'services/validation' src/services/git/\n   ```\n\n5. Verify index exports:\n   ```bash\n   echo '=== Git Exports ==='\n   cat src/services/git/index.ts\n   \n   echo '=== Validation Exports ==='\n   cat src/services/validation/index.ts\n   ```\n\n### Output\nReview report for both services:\n- Completeness status\n- TypeScript errors\n- Missing exports\n- Recommendations"
    },
    {
      "name": "write-git-tests",
      "model": "gemini-3-flash",
      "acceptanceCriteria": [
        "Test file at src/services/git/__tests__/git.test.ts",
        "Tests for utils, branch, commit, merge functions",
        "Mock git commands for isolation",
        "At least 12 test cases"
      ],
      "prompt": "## Task: Write Git Service Test Cases\n\n### Goal\nWrite test cases for the Git service.\n\n### Instructions\n1. Create test directory:\n   ```bash\n   mkdir -p src/services/git/__tests__\n   ```\n\n2. Review Git service functions:\n   ```bash\n   grep -E '^export (function|async function)' src/services/git/*.ts\n   ```\n\n3. Create test file:\n   ```bash\n   cat > src/services/git/__tests__/git.test.ts << 'EOF'\n   import * as git from '../index';\n   import { execSync } from 'child_process';\n   \n   // Mock child_process\n   jest.mock('child_process', () => ({\n     execSync: jest.fn(),\n   }));\n   \n   const mockExecSync = execSync as jest.MockedFunction<typeof execSync>;\n   \n   describe('Git Service', () => {\n     beforeEach(() => {\n       jest.clearAllMocks();\n     });\n     \n     describe('isGitRepo', () => {\n       it('should return true for valid git repo', () => {\n         mockExecSync.mockReturnValue('.git');\n         expect(git.isGitRepo('/some/path')).toBe(true);\n       });\n       \n       it('should return false for non-git directory', () => {\n         mockExecSync.mockImplementation(() => {\n           throw new Error('Not a git repo');\n         });\n         expect(git.isGitRepo('/not/a/repo')).toBe(false);\n       });\n     });\n     \n     describe('getCurrentBranch', () => {\n       it('should return current branch name', () => {\n         mockExecSync.mockReturnValue('main\\n');\n         expect(git.getCurrentBranch()).toBe('main');\n       });\n     });\n     \n     describe('branchExists', () => {\n       it('should return true for existing branch', () => {\n         mockExecSync.mockReturnValue('');\n         expect(git.branchExists('main')).toBe(true);\n       });\n     });\n     \n     // Add more tests for other functions...\n   });\n   EOF\n   ```\n\n4. Run tests:\n   ```bash\n   npm test -- --testPathPattern='services/git' --verbose\n   ```\n\n### Output\n- Test file created\n- Number of test cases\n- Initial test results"
    },
    {
      "name": "write-validation-tests",
      "model": "gemini-3-flash",
      "acceptanceCriteria": [
        "Test file at src/services/validation/__tests__/validation.test.ts",
        "Tests for environment, config, tasks, dependencies checks",
        "Tests cover edge cases (missing files, invalid JSON)",
        "At least 15 test cases"
      ],
      "prompt": "## Task: Write Validation Service Test Cases\n\n### Goal\nWrite test cases for the Validation service.\n\n### Instructions\n1. Create test directory:\n   ```bash\n   mkdir -p src/services/validation/__tests__\n   ```\n\n2. Review Validation service functions:\n   ```bash\n   grep -E '^export (function|async function)' src/services/validation/*.ts\n   ```\n\n3. Create test file:\n   ```bash\n   cat > src/services/validation/__tests__/validation.test.ts << 'EOF'\n   import * as validation from '../index';\n   import * as fs from 'fs';\n   import * as path from 'path';\n   \n   // Mock fs module\n   jest.mock('fs');\n   \n   const mockFs = fs as jest.Mocked<typeof fs>;\n   \n   describe('Validation Service', () => {\n     beforeEach(() => {\n       jest.clearAllMocks();\n     });\n     \n     describe('checkNodeVersion', () => {\n       it('should return no issues for valid Node version', () => {\n         const issues = validation.checkNodeVersion();\n         // Current Node should be valid\n         expect(issues.filter(i => i.severity === 'error')).toHaveLength(0);\n       });\n     });\n     \n     describe('checkConfigFile', () => {\n       it('should return warning when config file missing', () => {\n         mockFs.existsSync.mockReturnValue(false);\n         const issues = validation.checkConfigFile({ cwd: '/test' });\n         expect(issues.some(i => i.id === 'config.file.missing')).toBe(true);\n       });\n       \n       it('should return error for invalid JSON', () => {\n         mockFs.existsSync.mockReturnValue(true);\n         mockFs.readFileSync.mockReturnValue('{ invalid json }');\n         const issues = validation.checkConfigFile({ cwd: '/test' });\n         expect(issues.some(i => i.id === 'config.file.invalid')).toBe(true);\n       });\n     });\n     \n     describe('checkTasksDirectory', () => {\n       it('should return error when tasks dir missing', () => {\n         mockFs.existsSync.mockReturnValue(false);\n         const issues = validation.checkTasksDirectory({ tasksDir: '/missing' });\n         expect(issues.some(i => i.severity === 'error')).toBe(true);\n       });\n     });\n     \n     describe('checkDependencyCycles', () => {\n       it('should detect circular dependencies', () => {\n         // Setup mock file system with circular deps\n         mockFs.existsSync.mockReturnValue(true);\n         mockFs.readdirSync.mockReturnValue(['a.json', 'b.json'] as any);\n         mockFs.readFileSync\n           .mockReturnValueOnce(JSON.stringify({ dependsOn: ['b'] }))\n           .mockReturnValueOnce(JSON.stringify({ dependsOn: ['a'] }));\n         \n         const issues = validation.checkDependencyCycles({ tasksDir: '/tasks' });\n         expect(issues.some(i => i.id === 'deps.cycle')).toBe(true);\n       });\n     });\n   });\n   EOF\n   ```\n\n4. Run tests:\n   ```bash\n   npm test -- --testPathPattern='services/validation' --verbose\n   ```\n\n### Output\n- Test file created\n- Number of test cases\n- Initial test results"
    },
    {
      "name": "verify-services-tests",
      "model": "opus-4.5",
      "acceptanceCriteria": [
        "All Git service tests pass",
        "All Validation service tests pass",
        "Combined coverage > 50%"
      ],
      "prompt": "## Task: Verify Git and Validation Service Tests\n\n### Goal\nRun and verify all service tests.\n\n### Instructions\n1. Run Git service tests:\n   ```bash\n   npm test -- --testPathPattern='services/git' --verbose 2>&1 | tail -30\n   ```\n\n2. Run Validation service tests:\n   ```bash\n   npm test -- --testPathPattern='services/validation' --verbose 2>&1 | tail -30\n   ```\n\n3. Run both with coverage:\n   ```bash\n   npm test -- --testPathPattern='services/(git|validation)' --coverage --collectCoverageFrom='src/services/**/*.ts'\n   ```\n\n4. Summary:\n   ```bash\n   echo '=== Git Tests ==='\n   npm test -- --testPathPattern='services/git' 2>&1 | grep -E '(Tests:|PASS|FAIL)'\n   \n   echo '=== Validation Tests ==='\n   npm test -- --testPathPattern='services/validation' 2>&1 | grep -E '(Tests:|PASS|FAIL)'\n   ```\n\n5. Count total test cases:\n   ```bash\n   grep -rh 'it(\\|test(' src/services/git/__tests__ src/services/validation/__tests__ | wc -l\n   ```\n\n### Output\n- Git tests: X passed, X failed\n- Validation tests: X passed, X failed\n- Coverage: X%\n- Issues to fix"
    }
  ]
}

