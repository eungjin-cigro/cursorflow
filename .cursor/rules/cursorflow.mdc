---
description: CursorFlow í”„ë¡œì íŠ¸ ì „ì—­ ê·œì¹™ - ë³‘ë ¬ AI ì—ì´ì „íŠ¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì‹œìŠ¤í…œ
globs:
alwaysApply: true
---

# CursorFlow Repository Rules

## Project Context
CursorFlow is a parallel AI agent orchestration system built on Git worktrees. It enables running multiple AI-driven development "lanes" concurrently.

## ğŸ“š í•µì‹¬ ë¬¸ì„œ (Essential References)

ì½”ë“œ ì‘ì—… ì „ ë°˜ë“œì‹œ ì°¸ì¡°í•´ì•¼ í•˜ëŠ” í•µì‹¬ ë¬¸ì„œë“¤ì…ë‹ˆë‹¤. **ì¤‘ìš” ê¸°ëŠ¥ì´ ì¶”ê°€ë  ë•Œë§ˆë‹¤ ë°˜ë“œì‹œ ì—…ë°ì´íŠ¸ í•´ì•¼ í•©ë‹ˆë‹¤.**

| ë¬¸ì„œ | ê²½ë¡œ | ë‚´ìš© |
|---|---|---|
| **Architecture** | `docs/ARCHITECTURE.md` | **[í•„ë…]** í•µì‹¬ ì•„í‚¤í…ì²˜ ì›ì¹™, ê²©ë¦¬/ì¡°ìœ¨/ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜, C4 ê¸°ë°˜ ì„¤ëª… |
| **ADR Index** | `docs/ADR/README.md` | ì£¼ìš” ì„¤ê³„ ê²°ì • ê¸°ë¡ (Architecture Decision Records) |
| **Module Guide** | `docs/MODULE_GUIDE.md` | ëª¨ë“ˆ êµ¬ì¡°, í•µì‹¬ ì»´í¬ë„ŒíŠ¸ ì—­í• , ìƒí˜¸ì‘ìš© ë‹¤ì´ì–´ê·¸ë¨, ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ |
| **cursor-agent Guide** | `docs/CURSOR_AGENT_GUIDE.md` | cursor-agent CLI ì‚¬ìš©ë²•, ì¶œë ¥ í˜•ì‹(text/json/stream-json), tool_call íŒŒì‹± |
| **Test Architecture** | `docs/TEST_ARCHITECTURE.md` | í…ŒìŠ¤íŠ¸ ë ˆì´ì–´(Unit/Integration/E2E/Smoke), ìœ ì¦ˆì¼€ì´ìŠ¤ ë§¤í•‘ |
| **Hook System Guide** | `docs/HOOKS_GUIDE.md` | Hook ì‹œìŠ¤í…œ ì‚¬ìš©ë²•, Hook Points, FlowController API |

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ì„¤ê³„ ë° ê²°ì • (Architectural Decisions)

AI ì—ì´ì „íŠ¸(ë‹¹ì‹ )ëŠ” í”„ë¡œì íŠ¸ì˜ êµ¬ì¡°ë¥¼ ë³€ê²½í•˜ê±°ë‚˜ ì¤‘ìš”í•œ ê¸°ìˆ ì  ê²°ì •ì„ ë‚´ë¦´ ë•Œ ë‹¤ìŒ ì ˆì°¨ë¥¼ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤:

1. **ê¸°ì¡´ ì„¤ê³„ ê²€í† **: ì‘ì—…ì„ ì‹œì‘í•˜ê¸° ì „ `docs/ARCHITECTURE.md`ì™€ `docs/ADR/`ë¥¼ ì½ê³  í”„ë¡œì íŠ¸ì˜ ì„¤ê³„ ì² í•™ì„ ì´í•´í•˜ì‹­ì‹œì˜¤.
2. **ADR ì‘ì„±**: ì•„í‚¤í…ì²˜ ìˆ˜ì¤€ì˜ ê²°ì •(ìƒˆë¡œìš´ í†µì‹  íŒ¨í„´ ë„ì…, í•µì‹¬ ì—”ì§„ ë¡œì§ ë³€ê²½ ë“±)ì„ ë‚´ë¦´ ê²½ìš°, ë°˜ë“œì‹œ `docs/ADR/`ì— ìƒˆë¡œìš´ ADRì„ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
3. **Architecture ë¬¸ì„œ ì—…ë°ì´íŠ¸**: ì•„í‚¤í…ì²˜ ìˆ˜ì¤€ì˜ ë³€ê²½ì´ ë°œìƒí•˜ë©´ `docs/ARCHITECTURE.md`ì˜ ë‹¤ì´ì–´ê·¸ë¨ê³¼ ì„¤ëª…ì„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•˜ì‹­ì‹œì˜¤.
4. **ì¼ê´€ì„± ìœ ì§€**: ê¸°ì¡´ ì•„í‚¤í…ì²˜ íŒ¨í„´(Git ì›Œí¬íŠ¸ë¦¬ ê²©ë¦¬, ì´ë²¤íŠ¸ ê¸°ë°˜ ì¡°ìœ¨ ë“±)ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ë³€ê²½ì„ ì œì•ˆí•  ë•ŒëŠ” ëª…í™•í•œ ê·¼ê±°ë¥¼ ADRì— ì œì‹œí•˜ì‹­ì‹œì˜¤.

### CI/CD ì›Œí¬í”Œë¡œìš° ë¬¸ì„œ
| ì›Œí¬í”Œë¡œìš° | ê²½ë¡œ | ë‚´ìš© |
|------------|------|------|
| **CI** | `.github/workflows/ci.yml` | PR/Push í…ŒìŠ¤íŠ¸ íŒŒì´í”„ë¼ì¸ (unit â†’ contract â†’ integration â†’ smoke) |
| **Security** | `.github/workflows/security.yml` | ë³´ì•ˆ ìŠ¤ìº” (npm audit, Semgrep, Snyk, Trivy) |
| **NPM Publish** | `.github/workflows/npm-publish.yml` | íƒœê·¸ ê¸°ë°˜ NPM ë°°í¬ ì›Œí¬í”Œë¡œìš° |

### Module Guide í•µì‹¬ ìš”ì•½
- **Core Layer**: `orchestrator.ts`(ì¤‘ì•™ ê´€ë¦¬ì), `lane-state-machine.ts`(ìƒíƒœ ë¨¸ì‹ ), `git-lifecycle-manager.ts`(Git ìƒëª…ì£¼ê¸°)
- **Runner Layer**: `pipeline.ts`, `task.ts`, `agent.ts` - ê°œë³„ Lane ë‚´ Task ìˆœì°¨ ì‹¤í–‰
- **Services**: `logging/`, `process/` - ì¸í”„ë¼ ê¸°ëŠ¥
- **Utils**: `git.ts`, `state.ts`, `events.ts`, `event-registry.ts` - ê³µí†µ í—¬í¼

### cursor-agent ì£¼ìš” ì‚¬ìš© íŒ¨í„´
```bash
# CursorFlowì—ì„œ ì‚¬ìš©í•˜ëŠ” ê¸°ë³¸ íŒ¨í„´
cursor-agent --print --output-format stream-json --force --approve-mcps "í”„ë¡¬í”„íŠ¸"

# ì„¸ì…˜ ì¬ê°œ
cursor-agent --print --output-format stream-json --resume <chat-id> "í”„ë¡¬í”„íŠ¸"
```

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ëª…ë ¹ì–´
```bash
pnpm run test:unit          # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (~10ì´ˆ)
pnpm run test:contract      # Contract í…ŒìŠ¤íŠ¸ (~20ì´ˆ)
pnpm run test:integration   # í†µí•© í…ŒìŠ¤íŠ¸ (~60ì´ˆ)
pnpm run test:smoke         # ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ (~2ë¶„)
pnpm run test:e2e:real      # Real E2E (cursor-agent í•„ìš”, ~3-5ë¶„)
pnpm run test:verify        # ë¹Œë“œ + ìœ ë‹› + ìŠ¤ëª¨í¬
pnpm run test:ci            # CI ì „ì²´ í…ŒìŠ¤íŠ¸ ìˆœì°¨ ì‹¤í–‰
```



## General Principles
- **Safety First**: Never execute commands that could lead to data loss without confirmation.
- **Parallelism**: Respect the Git worktree-based architecture.
- **Traceability**: All operations should be logged or committed with clear messages.
- **Incremental Commits**: ê¸°ëŠ¥ í•˜ë‚˜ê°€ êµ¬í˜„ë  ë•Œë§ˆë‹¤ ì¦‰ì‹œ ì»¤ë°‹í•˜ì„¸ìš”. ì‘ì€ ë‹¨ìœ„ì˜ ì»¤ë°‹ì´ ë””ë²„ê¹…ê³¼ ë¡¤ë°±ì„ ìš©ì´í•˜ê²Œ í•©ë‹ˆë‹¤.
    - í•˜ë‚˜ì˜ ê¸°ëŠ¥/ìˆ˜ì • = í•˜ë‚˜ì˜ ì»¤ë°‹
    - ì»¤ë°‹ ì „ `npm run build`ë¡œ ë¹Œë“œ í™•ì¸
    - semantic commit message ì‚¬ìš© (e.g., `feat:`, `fix:`, `refactor:`)

## Tech Stack & Code Style
- **Language**: TypeScript (strict mode).
- **Runtime**: Node.js (>= 18.0.0).
- **Test Framework**: Jest.
- **Style Guide**:
    - Use async/await for asynchronous operations.
    - Prefer functional programming patterns where appropriate.
    - Use semantic commit messages (e.g., `feat:`, `fix:`, `chore:`, `docs:`, `refactor:`).
    - Ensure all public APIs are documented in JSDoc.

## NPM Deployment Best Practices
- **Release Flow**: Always use the provided release script for versioning and tagging.
    - Command: `./scripts/release.sh [patch|minor|major]`
    - This script handles:
        1. **Git Status Check**: Ensures the working directory is clean.
        2. **Branch Check**: Verifies that you are on the `main` branch.
        3. **Version Bump**: Updates `package.json` version using `npm version`.
        4. **CHANGELOG**: Prompts to update `CHANGELOG.md` before committing.
        5. **Tagging**: Creates a git tag (e.g., `v0.1.3`) for the release.
        6. **GitHub Push**: Pushes the commit and tag to trigger the GitHub Actions deployment workflow.

### âš ï¸ ë°°í¬ ì „ í•„ìˆ˜ í…ŒìŠ¤íŠ¸ (Pre-Release Testing)
**ë°°í¬ ì „ì— ë°˜ë“œì‹œ CIì™€ ë™ì¼í•œ í…ŒìŠ¤íŠ¸ë¥¼ ë¡œì»¬ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”:**
```bash
# CIì™€ ë™ì¼í•œ í…ŒìŠ¤íŠ¸ ìˆœì„œ
pnpm run build              # 1. ë¹Œë“œ
pnpm run test:unit          # 2. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
pnpm run test:contract      # 3. Contract í…ŒìŠ¤íŠ¸
pnpm run test:integration   # 4. í†µí•© í…ŒìŠ¤íŠ¸
pnpm run test:smoke         # 5. ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸

# ë˜ëŠ” í•œë²ˆì— ì‹¤í–‰ (ê¶Œì¥)
pnpm run test:ci            # ìœ„ ëª¨ë“  í…ŒìŠ¤íŠ¸ ìˆœì°¨ ì‹¤í–‰
```
**ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•´ì•¼ë§Œ ë²„ì „ íƒœê·¸ë¥¼ í‘¸ì‹œí•˜ì„¸ìš”!**

- **Pre-publish Checks**: The `prepublishOnly` script (`npm run build && npm run validate`) runs automatically. Never skip these checks as they ensure the package is functional and secure.
- **Validation**: Run `npm run validate` (which executes `npm pack --dry-run`) to verify the file list in the package bundle before initiating a release.
- **Deployment**: Actual publishing to NPM is handled by GitHub Actions upon pushing a new tag. Monitor the progress at the GitHub Actions tab.

## Security & Compliance
- **Security Gate**: Always run the local security gate before major changes or PRs.
    - Command: `npm run security:check` (runs `scripts/local-security-gate.sh`).
- **Included Checks**:
    - `npm audit`: Checks for high-severity dependency vulnerabilities.
    - `semgrep`: Static analysis for security patterns (similar to CodeQL).
    - `Secret Scan`: Checks for hardcoded API keys, tokens, or passwords.
    - `AI Security Analysis`: (Optional) AI-powered code security review (requires `OPENAI_API_KEY`).
- **Cloud Security**: For GitHub Actions, ensure `NPM_TOKEN`, `SNYK_TOKEN`, and `OPENAI_API_KEY` are configured.
- **Secrets Management**: Never commit `.env` files or hardcoded credentials. Use environment variables.
- **Package Integrity**: Use `npm run validate` to verify the package structure and ensure no sensitive files are included in the bundle.

## Testing & Quality Assurance
- **Unit Tests**: Run `npm test` frequently during development.
- **Test Projects**: Use the `test-projects/demo-project` for integration testing.
- **Scripts**: Use `./test-cursorflow.sh [setup|run|watch|clean]` to verify orchestrator behavior in a real-world scenario.

## Cursor IDE Integration
- **Custom Commands**: Support and maintain the custom slash commands:
    - `/cursorflow-init`: Initialize a project.
    - `/cursorflow-prepare`: Prepare tasks.
    - `/cursorflow-run`: Run orchestration.
    - `/cursorflow-monitor`: Monitor runs.
    - `/cursorflow-clean`: Clean resources.
    - `/cursorflow-resume`: Resume a lane.
    - `/cursorflow-doctor`: Verify environment and tasks.
    - `/cursorflow-signal`: Intervene in a running lane.
    - `/cursorflow-review`: Configure or check reviews.

## ğŸ“ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ê°€ì´ë“œë¼ì¸ (Document Update Guidelines)

ì½”ë“œ ë³€ê²½ ì‹œ ê´€ë ¨ ë¬¸ì„œë¥¼ ë°˜ë“œì‹œ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤.

### ì–´ë–¤ ë³€ê²½ì´ ë¬¸ì„œ ì—…ë°ì´íŠ¸ë¥¼ í•„ìš”ë¡œ í•˜ëŠ”ê°€?

| ì½”ë“œ ë³€ê²½ | ì—…ë°ì´íŠ¸í•  ë¬¸ì„œ |
|-----------|----------------|
| ìƒˆë¡œìš´ ëª¨ë“ˆ/ì»´í¬ë„ŒíŠ¸ ì¶”ê°€ | `docs/MODULE_GUIDE.md` |
| cursor-agent ì—°ë™ ë³€ê²½ | `docs/CURSOR_AGENT_GUIDE.md` |
| í…ŒìŠ¤íŠ¸ êµ¬ì¡° ë³€ê²½ | `docs/TEST_ARCHITECTURE.md` |
| Hook API ë³€ê²½ | `docs/HOOKS_GUIDE.md` |
| CLI ì»¤ë§¨ë“œ ì¶”ê°€/ë³€ê²½ | `README.md` |
| CI/CD ì›Œí¬í”Œë¡œìš° ë³€ê²½ | `.github/workflows/*.yml` ì£¼ì„ ë° README |
| ì„¤ì • ì˜µì…˜ ë³€ê²½ | `README.md`, í•´ë‹¹ ê°€ì´ë“œ ë¬¸ì„œ |

### ë¬¸ì„œ ì‘ì„± ì›ì¹™
1. **ì½”ë“œì™€ ë™ê¸°í™”**: ë¬¸ì„œê°€ í˜„ì¬ ì½”ë“œ ë™ì‘ì„ ì •í™•íˆ ë°˜ì˜í•´ì•¼ í•¨
2. **ì˜ˆì‹œ í¬í•¨**: ê°€ëŠ¥í•œ ê²½ìš° ì‹¤í–‰ ê°€ëŠ¥í•œ ì½”ë“œ ì˜ˆì‹œ í¬í•¨
3. **í•œê¸€/ì˜ì–´ ì¼ê´€ì„±**: ê¸°ì¡´ ë¬¸ì„œ ì–¸ì–´ ìŠ¤íƒ€ì¼ ë”°ë¥´ê¸°
4. **ë²„ì „ ì •ë³´**: í•„ìš”ì‹œ ë²„ì „ë³„ ë™ì‘ ì°¨ì´ ëª…ì‹œ

### ì»¤ë°‹ ì‹œ ë¬¸ì„œ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ìƒˆë¡œìš´ ê¸°ëŠ¥ì— ëŒ€í•œ ë¬¸ì„œê°€ ì¶”ê°€ë˜ì—ˆëŠ”ê°€?
- [ ] ë³€ê²½ëœ API/ì˜µì…˜ì— ëŒ€í•œ ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ê°€?
- [ ] ì˜ˆì‹œ ì½”ë“œê°€ ì‹¤ì œë¡œ ë™ì‘í•˜ëŠ”ê°€?
- [ ] ê´€ë ¨ Cursor rulesê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ê°€?
